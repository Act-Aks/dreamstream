name: Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Release ${{ matrix.package }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        package:
          - core
          - extractors
          - providers

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_RELEASE_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Act-Aks"
          git config --global user.email "akashsrivastava.git@gmail.com"

      - name: ðŸ“¦ Setup Dependencies
        uses: ./.github/actions/setup-dependency
        id: deps
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        with:
          package-manager: bun
          bun-version: 1.3.5
          cache-prefix: release-
          frozen-lockfile: true
          registry-url: https://npm.pkg.github.com

      - name: Build package with Turborepo
        run: bunx turbo run build --filter @dreamstream/${{ matrix.package }}

      - name: Run semantic-release
        working-directory: packages/${{ matrix.package }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
          GIT_AUTHOR_NAME: Act-Aks
          GIT_AUTHOR_EMAIL: akashsrivastava.git@gmail.com
          GIT_COMMITTER_NAME: Act-Aks
          GIT_COMMITTER_EMAIL: akashsrivastava.git@gmail.com
        run: bunx semantic-release

      - name: ðŸ“Š Release Summary
        if: always()
        run: |
          echo "ðŸ“Š Release Summary for @dreamstream/${{ matrix.package }}"
          echo "â€¢ Cache Hit: ${{ steps.deps.outputs.cache-hit }}"
          echo "â€¢ Package Manager: ${{ steps.deps.outputs.package-manager }}"

